<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
  <title>IP 获取演示 - WebRTC & API</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 2em auto;
      max-width: 700px;
      line-height: 1.7;
      color: #222;
      background: #fafbfc;
    }

    h1,
    h2 {
      color: #2b6cb0;
    }

    pre {
      background: #f4f4f4;
      border-radius: 4px;
      padding: 1em;
      overflow-x: auto;
      font-size: 0.97em;
    }

    section {
      margin-bottom: 2em;
    }
  </style>
</head>

<body>
  <a href="/">返回</a>
  <h1>IP 获取演示</h1>
  <section>
    <h2>WebRTC 获取本地 IP</h2>
    <pre id="webrtc-ip">加载中...</pre>
  </section>
  <section>
    <h2>API 获取 IP 信息</h2>
    <pre id="api-json">加载中...</pre>
  </section>

  <script>
    const stunServers = [
      { provider: 'Google', urls: 'stun:stun.l.google.com:19302' },
      { provider: 'Cloudflare', urls: 'stun:stun.cloudflare.com:3478' },
      { provider: 'XiaoMi', urls: 'stun:stun.miwifi.com:3478' },
      { provider: 'Bilibili', urls: 'stun:stun.chat.bilibili.com:3478' },
      { provider: 'Nextcloud', urls: 'stun:stun.nextcloud.com:3478' }
    ];

    async function getIpFromStun(serverConfig) {
      return new Promise((resolve) => {
        const RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
        if (!RTCPeerConnection) {
          resolve({ provider: serverConfig.provider, ips: ['不支持 WebRTC'], natType: '未知' });
          return;
        }

        const ips = new Set();
        const candidateTypes = new Set();
        const pc = new RTCPeerConnection({ iceServers: serverConfig.urls ? [serverConfig] : [] });
        pc.createDataChannel('');
        pc.createOffer().then(offer => pc.setLocalDescription(offer));

        pc.onicecandidate = (event) => {
          if (!event || !event.candidate) {
            pc.close();
            resolve({
              provider: serverConfig.provider,
              ips: Array.from(ips),
              natType: inferNatType(candidateTypes)
            });
            return;
          }
          if (event.candidate.type === 'srflx' || event.candidate.candidate.includes('srflx')) {
            const parts = event.candidate.candidate.split(' ');
            const ip = parts[4];
            if (ip) ips.add(ip);
          }
          candidateTypes.add(event.candidate.type);
        };
      });
    }

    function inferNatType(candidateTypes) {
      if (candidateTypes.has('srflx') && candidateTypes.has('relay')) {
        return '对称 NAT (Symmetric NAT)';
      }
      if (candidateTypes.has('srflx')) {
        return '受限锥形 NAT (Restricted Cone NAT)';
      }
      if (candidateTypes.has('host')) {
        return '全锥形 NAT (Full Cone NAT)';
      }
      return '未知 NAT 类型';
    }

    async function getAllStunIps() {
      const results = await Promise.all(stunServers.map(server => getIpFromStun(server)));
      return results;
    }

    getAllStunIps().then(results => {
      const output = results.map(r => {
        return `${r.provider}:\n${r.ips.length ? r.ips.join('\n') : '未获取到 IP'}\n${r.natType}`;
      }).join('\n\n');
      document.getElementById('webrtc-ip').textContent = output;
    });

    // API 获取 IP 信息
    fetch('/api?format=json')
      .then(r => r.json())
      .then(data => {
        document.getElementById('api-json').textContent = JSON.stringify(data, null, 2);
      })
      .catch(() => {
        document.getElementById('api-json').textContent = '获取失败';
      });
  </script>

</body>

</html>
